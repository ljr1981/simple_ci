name: Nightly Build - All Libraries

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      libraries:
        description: 'Space-separated list of libraries to test (empty = all)'
        required: false
        default: ''

env:
  ISE_EIFFEL: /usr/local/eiffel
  ISE_PLATFORM: linux-x86-64
  ISE_LIBRARY: /usr/local/eiffel
  SIMPLE_EIFFEL: /opt/simple_eiffel

jobs:
  nightly-tests:
    runs-on: [self-hosted, eiffel]
    timeout-minutes: 180

    steps:
    - name: Verify EiffelStudio
      run: |
        export PATH="$ISE_EIFFEL/studio/spec/$ISE_PLATFORM/bin:$PATH"
        echo "=== EiffelStudio Version ==="
        ec -version
        echo ""
        echo "=== Nightly Build Started: $(date -u) ==="

    - name: Setup all dependencies
      run: |
        mkdir -p $SIMPLE_EIFFEL
        cd $SIMPLE_EIFFEL

        # Comprehensive list of simple_* libraries
        DEPS="simple_ai_client simple_alpine simple_app_api simple_archive simple_base64 simple_cache simple_ci simple_cli simple_clipboard simple_codec simple_compression simple_config simple_console simple_cors simple_csv simple_datetime simple_decimal simple_docker simple_eiffel_parser simple_encryption simple_env simple_file simple_foundation_api simple_fraction simple_graph simple_grpc simple_hash simple_htmx simple_html simple_http simple_i18n simple_ipc simple_json simple_jwt simple_k8s simple_logger simple_lsp simple_markdown simple_math simple_mmap simple_mongo simple_mq simple_pdf simple_platform_api simple_process simple_randomizer simple_rate_limiter simple_regex simple_scheduler simple_service_api simple_setup simple_smtp simple_sql simple_system simple_telemetry simple_template simple_testing simple_toml simple_uuid simple_validation simple_watcher simple_web simple_websocket simple_xml simple_yaml"

        echo "=== Cloning/Updating all libraries ==="
        for lib in $DEPS; do
          if [ -d "$lib" ]; then
            echo "Updating $lib..."
            cd "$lib" && git pull --ff-only 2>/dev/null || git fetch origin && git reset --hard origin/main 2>/dev/null || git reset --hard origin/master 2>/dev/null || true
            cd $SIMPLE_EIFFEL
          else
            echo "Cloning $lib..."
            git clone --depth 1 https://github.com/simple-eiffel/$lib.git 2>/dev/null || true
          fi
        done

        echo ""
        echo "Libraries available: $(ls -d */ | wc -l)"

    - name: Pre-compile C libraries
      run: |
        cd $SIMPLE_EIFFEL
        for lib in simple_env simple_process simple_mmap simple_system simple_watcher; do
          if [ -d "$lib/Clib" ]; then
            echo "=== Compiling C code for $lib ==="
            cd "$lib/Clib"
            rm -f *.o
            for cfile in *.c; do
              if [ -f "$cfile" ]; then
                gcc -c -fPIC "$cfile" -o "${cfile%.c}.o"
              fi
            done
            cd $SIMPLE_EIFFEL
          fi
        done

    - name: Run nightly tests
      run: |
        export PATH="$ISE_EIFFEL/studio/spec/$ISE_PLATFORM/bin:$PATH"
        cd $SIMPLE_EIFFEL

        # Priority libraries to test (those with tests and CI enabled)
        if [ -n "${{ github.event.inputs.libraries }}" ]; then
          TEST_LIBS="${{ github.event.inputs.libraries }}"
        else
          TEST_LIBS="simple_testing simple_json simple_base64 simple_foundation_api simple_datetime simple_logger simple_file simple_toml simple_http simple_xml simple_env simple_process simple_mmap simple_system simple_watcher simple_k8s"
        fi

        echo "=== Testing libraries: $TEST_LIBS ==="
        echo ""

        PASSED=0
        FAILED=0
        FAILED_LIBS=""

        for lib in $TEST_LIBS; do
          echo ""
          echo "========================================"
          echo "Testing: $lib"
          echo "========================================"

          if [ ! -d "$lib" ]; then
            echo "SKIP: $lib not found"
            continue
          fi

          cd "$lib"

          # Find ECF file
          ECF_FILE=$(find . -maxdepth 1 -name "*.ecf" | head -1)
          if [ -z "$ECF_FILE" ]; then
            echo "SKIP: No ECF file found"
            cd $SIMPLE_EIFFEL
            continue
          fi

          # Find test target
          TEST_TARGET=$(grep -o 'target name="[^"]*_tests"' "$ECF_FILE" | sed 's/target name="//;s/"$//' | head -1)
          if [ -z "$TEST_TARGET" ]; then
            TEST_TARGET=$(grep -o 'target name="[^"]*"' "$ECF_FILE" | sed 's/target name="//;s/"$//' | head -1)
          fi

          echo "ECF: $ECF_FILE, Target: $TEST_TARGET"

          # Clean and compile
          rm -rf EIFGENs
          if ec -batch -config "$ECF_FILE" -target "$TEST_TARGET" -c_compile 2>&1 | tail -10; then
            # Find and run executable
            EXECUTABLE=$(find EIFGENs -type f -executable 2>/dev/null | grep -v "\.o$" | head -1)
            if [ -n "$EXECUTABLE" ]; then
              echo "Running: $EXECUTABLE"
              if "$EXECUTABLE" 2>&1; then
                echo "PASS: $lib"
                PASSED=$((PASSED + 1))
              else
                echo "FAIL: $lib (test execution failed)"
                FAILED=$((FAILED + 1))
                FAILED_LIBS="$FAILED_LIBS $lib"
              fi
            else
              echo "FAIL: $lib (no executable)"
              FAILED=$((FAILED + 1))
              FAILED_LIBS="$FAILED_LIBS $lib"
            fi
          else
            echo "FAIL: $lib (compilation failed)"
            FAILED=$((FAILED + 1))
            FAILED_LIBS="$FAILED_LIBS $lib"
          fi

          cd $SIMPLE_EIFFEL
        done

        echo ""
        echo "========================================"
        echo "=== NIGHTLY BUILD SUMMARY ==="
        echo "========================================"
        echo "Passed: $PASSED"
        echo "Failed: $FAILED"
        if [ -n "$FAILED_LIBS" ]; then
          echo "Failed libraries:$FAILED_LIBS"
        fi
        echo "Completed: $(date -u)"
        echo "========================================"

        # Exit with error if any tests failed
        if [ $FAILED -gt 0 ]; then
          exit 1
        fi
      timeout-minutes: 150
